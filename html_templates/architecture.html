{% extends "base.html" %}

{% set current_page = "architecture" %}

{% block title %}Architecture{% endblock %}
{% block page_title %}{{ project_name | default('Project') }} Architecture{% endblock %}
{% block breadcrumb_title %}Architecture{% endblock %}

{% block toc %}
<li class="md-nav__item"><a href="#overview" class="md-nav__link">Overview</a></li>
{% if diagrams.dataflow %}<li class="md-nav__item"><a href="#data-flow" class="md-nav__link">Data Flow</a></li>{% endif %}
<li class="md-nav__item"><a href="#components" class="md-nav__link">Components</a></li>
<li class="md-nav__item"><a href="#modules" class="md-nav__link">Modules</a></li>
<li class="md-nav__item"><a href="#module-structures" class="md-nav__link">Module Structures</a></li>
<li class="md-nav__item"><a href="#all-modules" class="md-nav__link">All Modules</a></li>
{% endblock %}

{% block content %}
<h1 id="overview">{{ project_name | default('Project') }} Architecture</h1>
<p>Comprehensive multi-level view of the system's architectural components, patterns, and relationships.</p>

<!-- Repository Overview -->
<section class="overview-section">
    <h2>üè† Repository Structure</h2>
    <p>Actual repository organization based on detected structure and main directories.</p>
    
    <div id="repo-structure-dynamic" class="diagram-section">
        <h3>Live Repository Structure</h3>
        <div class="loading-placeholder">
            <div class="loading-spinner">üîÑ</div>
            <span>Loading repository structure...</span>
        </div>
    </div>
</section>

<!-- Enterprise Architecture -->
<section class="enterprise-section">
    <h2>üè¢ Enterprise Architecture</h2>
    <p>System-level components, integrations, and data flows based on detected patterns.</p>
    
    <div id="enterprise-arch-dynamic" class="diagram-section">
        <h3>Live System Architecture</h3>
        <div class="loading-placeholder">
            <div class="loading-spinner">üîÑ</div>
            <span>Analyzing system components...</span>
        </div>
    </div>
</section>

<!-- Logical Architecture -->
<section class="logical-section">
    <h2>üß† Logical Architecture</h2>
    <p>Data flow patterns and component interactions based on actual code analysis.</p>
    
    <div id="logical-arch-dynamic" class="diagram-section">
        <h3>Live Data Flow Analysis</h3>
        <div class="loading-placeholder">
            <div class="loading-spinner">üîÑ</div>
            <span>Analyzing component relationships...</span>
        </div>
    </div>
</section>

<!-- Physical Architecture -->
<section class="physical-section">
    <h2>üñ•Ô∏è Physical Architecture</h2>
    <p>Deployment patterns, runtime environments, and infrastructure detected from configuration files.</p>
    
    <div id="physical-arch-dynamic" class="diagram-section">
        <h3>Live Deployment Analysis</h3>
        <div class="loading-placeholder">
            <div class="loading-spinner">üîÑ</div>
            <span>Detecting deployment configurations...</span>
        </div>
    </div>
</section>

<!-- Pipeline Architecture -->
<section class="pipeline-section">
    <h2>‚öôÔ∏è Pipeline Architecture</h2>
    <p>Data processing pipelines, AI enhancement workflows, and content generation flows.</p>
    
    <div id="pipeline-arch-dynamic" class="diagram-section">
        <h3>Live Pipeline Analysis</h3>
        <div class="loading-placeholder">
            <div class="loading-spinner">üîÑ</div>
            <span>Analyzing processing pipelines...</span>
        </div>
    </div>
</section>

<!-- System Component Overview -->
<section class="system-components">
    <h2>üèóÔ∏è System Component Overview</h2>
    <p>Actual system components detected from code analysis with their relationships and dependencies.</p>
    
    <div id="system-components-dynamic" class="diagram-section">
        <h3>Live Component Analysis</h3>
        <div class="loading-placeholder">
            <div class="loading-spinner">üîÑ</div>
            <span>Analyzing system components...</span>
        </div>
    </div>
</section>

<!-- <section class="components-overview" id="components">
    <h2>üì¶ System Components</h2>
    <p>High-level overview of major system components and their roles.</p>
    <div class="getting-started-grid" id="components-grid"></div>
</section> -->

<!-- High-Level Module Architecture -->
<section class="top-modules-section">
    <h2 id="modules">üìÅ Module Architecture</h2>
    <p>High-level view of core modules and their architectural relationships.</p>
    <div id="arch-dynamic-diagram" class="diagram-section">
        <h3>Live Module Dependency Flow (Repository Analysis)</h3>
        <div class="loading-placeholder">
            <div class="loading-spinner">üîÑ</div>
            <span>Analyzing module dependencies...</span>
        </div>
    </div>
    

    <!-- Top Modules Summary Table -->
    {% if modules %}
    <div class="top-modules-table">
        <h3>Key Contributing Modules</h3>
        <table>
          <thead>
            <tr>
              <th>Module</th>
              <th>Layer</th>
              <th>Primary Function</th>
              <th>Complexity</th>
              <th>Impact</th>
            </tr>
          </thead>
          <tbody>
            {% for module in modules[:8] %}
            <tr>
              <td><strong>{{ module.name }}</strong><br/><code>{{ module.path }}</code></td>
              <td>
                {% if 'main' in module.path.lower() or 'cli' in module.path.lower() %}
                <span class="layer-badge ui">UI Layer</span>
                {% elif 'analyzer' in module.path.lower() or 'generator' in module.path.lower() %}
                <span class="layer-badge business">Business Logic</span>
                {% elif 'template' in module.path.lower() or 'html' in module.path.lower() %}
                <span class="layer-badge features">Product Features</span>
                {% else %}
                <span class="layer-badge data">Data Layer</span>
                {% endif %}
              </td>
              <td>
                {% if 'analyzer' in module.path.lower() %}
                üîç Code Analysis & Parsing
                {% elif 'generator' in module.path.lower() %}
                üìÑ Documentation Generation
                {% elif 'main' in module.path.lower() %}
                üöÄ Application Orchestration
                {% elif 'template' in module.path.lower() %}
                üìã Template Processing
                {% else %}
                ‚öôÔ∏è System Component
            {% endif %}
              </td>
              <td>
                {% set complexity = (module.functions | length) + (module.classes | length * 2) %}
                <span class="complexity-indicator complexity-{{ 'high' if complexity > 15 else ('medium' if complexity > 5 else 'low') }}">
                  {{ 'High' if complexity > 15 else ('Medium' if complexity > 5 else 'Low') }}
                </span>
              </td>
              <td>
                {% set impact = (module.lines_of_code | default(0)) / 100 + (module.functions | length) + (module.classes | length * 2) %}
                <div class="impact-bar" data-impact="{{ impact | round }}">
                  <div class="impact-fill"></div>
                  <span class="impact-text">{{ impact | round }}</span>
                </div>
              </td>
            </tr>
    {% endfor %}
          </tbody>
        </table>
</div>
{% endif %}
<!-- Module Code Structure (populated by data-integration.js) -->
<!-- <section class="module-structures" id="module-structures">
    <h2>üìÅ Modules</h2>
    <p>Code structure per file with a simple diagram and listed components.</p>
    <div id="modules-structure" class="getting-started-grid"></div>
    
</section> -->

<!-- All Modules Table mirrored under Architecture -->
<!-- <section id="all-modules">
  <h2>All Detected Modules</h2>
  <div class="toolbar" style="margin: 1rem 0; display: flex; gap: .75rem; align-items: center;">
    <input id="all-modules-search" type="search" placeholder="Search modules, paths‚Ä¶" aria-label="Search modules" style="flex:1; padding:.6rem 1rem; border:1px solid var(--color-border); border-radius:.5rem; background: var(--color-bg); color: var(--color-text);">
    <span id="all-modules-count" class="md-nav__count"></span>
  </div>
  <div class="table-responsive">
    <table class="table" style="width:100%; border-collapse: collapse;">
      <thead>
        <tr>
          <th style="text-align:left; padding:.5rem; border-bottom:1px solid var(--color-border);">Module</th>
          <th style="text-align:left; padding:.5rem; border-bottom:1px solid var(--color-border);">Path</th>
          <th style="text-align:right; padding:.5rem; border-bottom:1px solid var(--color-border);">Functions</th>
          <th style="text-align:right; padding:.5rem; border-bottom:1px solid var(--color-border);">Classes</th>
          <th style="text-align:right; padding:.5rem; border-bottom:1px solid var(--color-border);">Lines</th>
          <th style="text-align:left; padding:.5rem; border-bottom:1px solid var(--color-border);">Description</th>
        </tr>
      </thead>
      <tbody id="all-modules-body"></tbody>
    </table>
  </div>
</section> -->

<style>
/* Loading placeholders */
.loading-placeholder {
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 2rem;
    border: 2px dashed #e2e8f0;
    border-radius: 8px;
    background: #f8fafc;
    color: #64748b;
    font-style: italic;
}

.loading-spinner {
    animation: spin 2s linear infinite;
    margin-right: 0.5rem;
    font-size: 1.2rem;
}

@keyframes spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
}

/* Diagram sections */
.diagram-section {
    margin: 1.5rem 0;
}

.diagram-info {
    margin-top: 1rem;
    padding: 0.5rem 1rem;
    background: #f1f5f9;
    border-left: 4px solid #3b82f6;
    border-radius: 0 4px 4px 0;
    font-size: 0.9rem;
    color: #475569;
}

.fallback-diagram {
    padding: 1.5rem;
    border: 2px solid #d1d5db;
    border-radius: 8px;
    background: #f9fafb;
}

.fallback-diagram h3 {
    margin-top: 0;
    color: #374151;
}

/* Top Modules specific styles */
.top-modules-section {
    margin-top: 2rem;
}

.top-modules-table {
    margin-top: 2rem;
}

.layer-badge {
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
    font-size: 0.75rem;
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.layer-badge.ui {
    background: #e3f2fd;
    color: #1976d2;
}

.layer-badge.business {
    background: #e8f5e8;
    color: #388e3c;
}

.layer-badge.features {
    background: #fff3e0;
    color: #f57c00;
}

.layer-badge.data {
    background: #f3e5f5;
    color: #7b1fa2;
}

.complexity-indicator {
    padding: 0.2rem 0.4rem;
    border-radius: 3px;
    font-size: 0.8rem;
    font-weight: 500;
}

.complexity-indicator.complexity-low {
    background: #e8f5e8;
    color: #4caf50;
}

.complexity-indicator.complexity-medium {
    background: #fff3e0;
    color: #ff9800;
}

.complexity-indicator.complexity-high {
    background: #ffebee;
    color: #f44336;
}

.impact-bar {
    position: relative;
    width: 100px;
    height: 20px;
    background: #f0f0f0;
    border-radius: 10px;
    overflow: hidden;
}

.impact-fill {
    height: 100%;
    background: linear-gradient(90deg, #4caf50, #2196f3);
    transition: width 0.3s ease;
}

.impact-text {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    font-size: 0.7rem;
    font-weight: bold;
    color: #333;
    text-shadow: 0 0 2px rgba(255,255,255,0.8);
}
</style>

<script src="assets/js/mermaid.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function(){
  if (window.mermaid) { 
    mermaid.initialize({ 
      startOnLoad: true,
      theme: 'default',
      flowchart: { useMaxWidth: true },
      sequence: { useMaxWidth: true },
      classDiagram: { useMaxWidth: true }
    }); 
  }
  
  // Set impact bar widths
  document.querySelectorAll('.impact-bar').forEach(function(bar) {
    const impact = parseInt(bar.getAttribute('data-impact'));
    const percentage = Math.min((impact / 50) * 100, 100);
    const fill = bar.querySelector('.impact-fill');
    if (fill) {
      fill.style.width = percentage + '%';
    }
  });
});
</script>
{% endblock %}

{% block extra_css %}
<style>
  /* Enhanced table visuals for Architecture page section */
  #all-modules .table-responsive {
    border: 1px solid var(--color-border);
    border-radius: .5rem;
    overflow: auto;
    box-shadow: 0 4px 16px rgba(0,0,0,0.05);
    max-height: 60vh;
  }
  #all-modules table thead th {
    position: sticky;
    top: 0;
    background: var(--color-bg);
    z-index: 1;
  }
  #all-modules table tbody tr:nth-child(odd) { background: rgba(0,0,0,0.02); }
  #all-modules table tbody tr:hover { background: rgba(59,130,246,0.08); }
  #all-modules td code {
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    display: inline-block;
    max-width: 40ch;
  }
  #all-modules td:nth-child(3),
  #all-modules td:nth-child(4),
  #all-modules td:nth-child(5) { font-variant-numeric: tabular-nums; width: 6rem; }
  #all-modules thead th:first-child { border-top-left-radius: .5rem; }
  #all-modules thead th:last-child { border-top-right-radius: .5rem; }
</style>
{% endblock %}


